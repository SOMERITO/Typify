<script>
    const BIN_ID = '69681a15d0ea881f406c588a'; // BIN P√öBLICO
    let db = [];
    let editIdx = -1;
    let filtro = "TODOS";
    let deleteIdx = null;

    const loader = document.getElementById('loader');
    const cloudStatus = document.getElementById('cloudStatus');

    /* =========================
       CARGA DE DATOS (SOLO LECTURA)
    ========================= */
    async function cargarDatos() {
        try {
            const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`);
            if (!res.ok) throw new Error();

            const data = await res.json();
            db = Array.isArray(data.record) ? data.record : [];

            cloudStatus.innerHTML = "‚òÅÔ∏è Nube activa (solo lectura)";
            cloudStatus.classList.remove('error');

            // Si no hay nada local, copiamos nube ‚Üí local
            if (!localStorage.getItem('misTipificaciones')) {
                localStorage.setItem('misTipificaciones', JSON.stringify(db));
            }

        } catch {
            cloudStatus.innerHTML = "‚ö†Ô∏è Modo local";
            cloudStatus.classList.add('error');
            db = JSON.parse(localStorage.getItem('misTipificaciones')) || [];
        }

        renderChips();
        renderResults();
        loader.classList.add('hidden');
    }

    /* =========================
       GUARDADO LOCAL
    ========================= */
    function guardarLocal() {
        localStorage.setItem('misTipificaciones', JSON.stringify(db));
        mostrarToast("üíæ Guardado local");
    }

    /* =========================
       UI Y L√ìGICA
    ========================= */
    const paleta = [
        {bg:'#e0e7ff',text:'#4338ca'},{bg:'#dcfce7',text:'#15803d'},
        {bg:'#ffedd5',text:'#c2410c'},{bg:'#fee2e2',text:'#b91c1c'},
        {bg:'#fae8ff',text:'#a21caf'},{bg:'#ccfbf1',text:'#0f766e'},
        {bg:'#fef9c3',text:'#a16207'},{bg:'#f3e8ff',text:'#7e22ce'},
        {bg:'#e0f2fe',text:'#0369a1'},{bg:'#ffe4e6',text:'#be123c'},
        {bg:'#f1f5f9',text:'#475569'}
    ];

    function getColor(t){
        if(!t) return paleta[10];
        let s=0; for(let i=0;i<t.length;i++) s+=t.charCodeAt(i);
        return paleta[s % paleta.length];
    }

    const inputBusqueda = document.getElementById('inputBusqueda');
    const btnLimpiar = document.getElementById('btnLimpiar');
    const resultsDiv = document.getElementById('results');
    const chipsDiv = document.getElementById('chipsArea');
    const toast = document.getElementById('toast-msg');

    const modalOverlay = document.getElementById('modalOverlay');
    const deleteOverlay = document.getElementById('deleteOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const btnSave = document.getElementById('btnSave');

    const inClass = document.getElementById('inClass');
    const inTitle = document.getElementById('inTitle');
    const inDesc = document.getElementById('inDesc');
    const inRoute = document.getElementById('inRoute');

    window.onload = cargarDatos;

    function mostrarToast(m) {
        toast.innerText = m;
        toast.classList.add('show');
        setTimeout(()=>toast.classList.remove('show'),2000);
    }

    function renderChips() {
        const cats = [...new Set(db.map(x=>x.clasificacion).filter(Boolean))];
        chipsDiv.innerHTML='';
        makeChip("TODOS","Todos");
        cats.forEach(c=>makeChip(c,c));
    }

    function makeChip(v,l){
        const b=document.createElement('button');
        b.className='chip-final';
        b.innerText=l;
        b.onclick=()=>{filtro=v;renderChips();renderResults(inputBusqueda.value);};
        chipsDiv.appendChild(b);
    }

    function renderResults(t=""){
        resultsDiv.innerHTML='';
        const txt=t.toLowerCase();

        const f=db.map((x,i)=>({...x,idx:i})).filter(x=>{
            const mTxt = x.titulo.toLowerCase().includes(txt) ||
                         x.descripcion.toLowerCase().includes(txt);
            const mFil = filtro==="TODOS" || x.clasificacion===filtro;
            return mTxt && mFil;
        });

        if(!f.length){
            resultsDiv.innerHTML='<div style="text-align:center;color:#94a3b8;">Vac√≠o</div>';
            return;
        }

        f.forEach(item=>{
            const d=document.createElement('div');
            d.className='card-final';
            d.innerHTML=`
                <div class="card-header">
                    <div>
                        <div class="titulo">${item.titulo}</div>
                    </div>
                    <div class="actions">
                        <button onclick="editar(${item.idx})">‚úèÔ∏è</button>
                        <button onclick="preDelete(${item.idx})">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="desc-box" onclick="copiar(${item.idx})">
                    <pre class="desc-text">${item.descripcion}</pre>
                </div>
                <div class="ruta">${item.ruta || ""}</div>`;
            resultsDiv.appendChild(d);
        });
    }

    function copiar(i){
        navigator.clipboard.writeText(db[i].descripcion);
        mostrarToast("üìã Copiado");
    }

    function abrirModal(){
        editIdx=-1;
        modalTitle.innerText="Nueva Tipificaci√≥n";
        btnSave.innerText="Guardar";
        inClass.value=inTitle.value=inDesc.value=inRoute.value="";
        modalOverlay.classList.add('active');
    }

    function editar(i){
        editIdx=i;
        const x=db[i];
        modalTitle.innerText="Editar";
        btnSave.innerText="Actualizar";
        inClass.value=x.clasificacion||"";
        inTitle.value=x.titulo;
        inDesc.value=x.descripcion;
        inRoute.value=x.ruta||"";
        modalOverlay.classList.add('active');
    }

    function cerrarModal(){ modalOverlay.classList.remove('active'); }

    function guardar(){
        const o={
            clasificacion:inClass.value.trim().toUpperCase(),
            titulo:inTitle.value.trim(),
            descripcion:inDesc.value,
            ruta:inRoute.value.trim()
        };
        if(!o.titulo) return alert("Falta t√≠tulo");
        editIdx===-1 ? db.unshift(o) : db[editIdx]=o;
        guardarLocal();
        cerrarModal();
        renderChips();
        renderResults(inputBusqueda.value);
    }

    function preDelete(i){ deleteIdx=i; deleteOverlay.classList.add('active'); }
    function cerrarDelete(){ deleteOverlay.classList.remove('active'); deleteIdx=null; }
    function confirmDelete(){
        if(deleteIdx===null) return;
        db.splice(deleteIdx,1);
        guardarLocal();
        cerrarDelete();
        renderChips();
        renderResults(inputBusqueda.value);
    }
</script>
