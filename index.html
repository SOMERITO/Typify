<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typify Cloud Pro</title>
    <style>
        :root { 
            --p:#4f46e5; --p-light:rgba(79, 70, 229, 0.1); --s:#ec4899; 
            --bg:#f8fafc; --t:#0f172a; --ok:#10b981; --err:#ef4444; 
            --shadow-lg: 0 10px 25px -3px rgba(0,0,0,0.1);
        }
        
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--t); margin:0; padding:40px 20px; display:flex; flex-direction:column; align-items:center; min-height:100vh; overflow-x: hidden; }

        /* --- TOOLKIT DE ANIMACIONES RECARGADO --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform:rotate(360deg); } }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideOutRight { to { transform: translateX(100%); opacity: 0; } }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }

        .loading-overlay { position:fixed; inset:0; background:rgba(255,255,255,0.95); z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center; transition: 0.5s; }
        .loading-overlay.hidden { opacity:0; visibility:hidden; }
        .spinner { width:50px; height:50px; border:5px solid #e2e8f0; border-top-color:var(--p); border-radius:50%; animation: spin 1s linear infinite; margin-bottom:15px; }

        .header { width:100%; max-width:800px; text-align:center; margin-bottom:30px; animation: fadeIn 0.6s ease-out; }
        h1 { margin:0 0 10px; background: linear-gradient(to right, var(--p), var(--s)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-size:2.8rem; font-weight:800; letter-spacing: -1px; }
        
        .status { font-size:0.85rem; font-weight:700; padding:6px 18px; border-radius:20px; display:inline-flex; align-items:center; gap:8px; background:#e2e8f0; transition: 0.3s; }
        .status.active { background:#dcfce7; color:var(--ok); }
        .status.local { background:#fee2e2; color:var(--err); }

        .search-area { width:100%; max-width:700px; display:flex; gap:12px; margin-top:25px; animation: fadeIn 0.8s ease-out; }
        input { flex:1; padding:18px 25px; border-radius:20px; border:2px solid transparent; background:white; box-shadow: var(--shadow-lg); font-size:1.2rem; outline:none; transition:0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        input:focus { border-color:var(--p); box-shadow: 0 0 0 5px var(--p-light), var(--shadow-lg); transform: scale(1.01); }
        
        .btn-x { width:58px; height:58px; border-radius:18px; border:2px solid var(--err); background:white; color:var(--err); cursor:pointer; font-weight:800; display:flex; align-items:center; justify-content:center; visibility: hidden; opacity:0; transition:0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .btn-x.show { visibility: visible; opacity:1; animation: pop 0.4s forwards; }
        .btn-x:hover { background: var(--err); color: white; transform: rotate(90deg) scale(1.1); box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3); }

        .chips { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:25px; animation: fadeIn 1s ease-out; }
        .chip { background:white; border:1px solid #e2e8f0; padding:8px 20px; border-radius:20px; cursor:pointer; font-size:0.95rem; font-weight:700; transition:0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .chip:hover { transform: translateY(-2px); border-color: var(--p); color: var(--p); }
        .chip.active { background:var(--p)!important; color:white!important; border-color: var(--p)!important; transform: scale(1.05); box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3); }

        /* TARJETAS */
        #results { width:100%; max-width:800px; display:grid; gap:20px; margin-top:30px; padding-bottom:120px; }
        .card { background:white; padding:25px; border-radius:22px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.05); position:relative; overflow:hidden; transition:0.3s cubic-bezier(0.4, 0, 0.2, 1); opacity:0; animation: fadeIn 0.5s forwards; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .card.deleting { animation: slideOutRight 0.5s forwards ease-in; }
        .card-bar { position:absolute; left:0; top:0; bottom:0; width:6px; opacity: 0.8; }
        
        .card .titulo { font-weight:800; font-size:1.3rem; margin-bottom:15px; color: var(--t); line-height: 1.2; }
        .card .badge { display:inline-block; font-size:0.75rem; font-weight:800; padding:5px 12px; border-radius:8px; text-transform:uppercase; margin-bottom:10px; letter-spacing: 0.5px; }
        
        .box { background:#f1f5f9; border-radius:12px; padding:15px; cursor:pointer; border:1px solid #cbd5e1; transition:0.2s; position:relative; }
        .box:hover { border-color:var(--p); background:white; box-shadow: 0 0 0 3px var(--p-light); }
        .box pre { margin:0; font-family:inherit; white-space:pre-wrap; color:#334155; line-height:1.6; font-size:1rem; }
        
        .ruta { font-family:monospace; font-size:0.85rem; color:#64748b; margin-top:15px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        
        .btns { position:absolute; top:20px; right:20px; display:flex; gap:8px; opacity: 0; transition: 0.3s; transform: translateX(10px); }
        .card:hover .btns { opacity: 1; transform: translateX(0); }
        .btn-a { background:#f1f5f9; border:none; padding:8px; border-radius:10px; cursor:pointer; font-size:1.2rem; transition: 0.2s; color: #94a3b8; }
        .btn-a:hover { transform: scale(1.1); background: #e2e8f0; color: var(--p); }
        .btn-a.del-btn:hover { color: var(--err); background: #fee2e2; }

        /* FAB ANIMADO */
        .fab { position:fixed; bottom:35px; right:35px; width:65px; height:65px; background:linear-gradient(135deg, var(--p), var(--s)); border-radius:50%; border:none; color:white; font-size:35px; cursor:pointer; box-shadow:0 10px 25px rgba(79,70,229,0.4); z-index:100; transition:0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; justify-content: center; animation: pulse-glow 3s infinite; }
        .fab:hover { transform: scale(1.15) rotate(90deg); }

        .overlay { position:fixed; inset:0; background:rgba(15,23,42,0.6); backdrop-filter:blur(8px); display:none; align-items:center; justify-content:center; z-index:200; }
        .overlay.active { display:flex; animation: fadeIn 0.3s; }
        .modal { background:white; width:95%; max-width:550px; padding:35px; border-radius:30px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); transform: scale(0.9); transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .overlay.active .modal { transform: scale(1); }
        
        #toast { visibility:hidden; background:#0f172a; color:white; padding:15px 30px; border-radius:50px; position:fixed; bottom:40px; left:50%; transform:translateX(-50%); transition:0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index:3000; font-weight: 700; box-shadow: 0 15px 30px rgba(0,0,0,0.3); opacity: 0; }
        #toast.show { visibility:visible; bottom:60px; opacity: 1; }
    </style>
</head>
<body>
    <div id="loader" class="loading-overlay"><div class="spinner"></div><h3>Sincronizando Typify Cloud...</h3></div>
    
    <div class="header">
        <h1>Typify</h1>
        <div id="status" class="status">Cargando base de datos...</div>
        <div class="search-area">
            <input type="text" id="q" placeholder="Buscar tipificaci√≥n..." autocomplete="off">
            <button id="bx" class="btn-x" title="Limpiar b√∫squeda (Esc)">‚úï</button>
        </div>
        <div id="chips" class="chips"></div>
    </div>

    <div id="results"></div>

    <button class="fab" onclick="modal(-1)" title="Nuevo Registro">+</button>

    <div id="m" class="overlay">
        <div class="modal">
            <h2 id="mt" style="margin:0 0 25px; color:var(--p); text-align: center; font-size: 1.8rem;">Nueva Tipificaci√≥n</h2>
            <div style="display:flex; gap:15px;">
                <div style="flex:1; margin-bottom: 20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:700; color:#475569; font-size:0.8rem; text-transform:uppercase;">Categor√≠a</label>
                    <input id="ic" style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:14px; box-sizing:border-box;" placeholder="Ej: PASOS">
                </div>
                <div style="flex:2; margin-bottom: 20px;">
                    <label style="display:block; margin-bottom:8px; font-weight:700; color:#475569; font-size:0.8rem; text-transform:uppercase;">T√≠tulo</label>
                    <input id="it" style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:14px; box-sizing:border-box;" placeholder="Nombre del caso">
                </div>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display:block; margin-bottom:8px; font-weight:700; color:#475569; font-size:0.8rem; text-transform:uppercase;">Contenido Exacto</label>
                <textarea id="id" rows="6" style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:14px; box-sizing:border-box; font-family: inherit; resize: none;"></textarea>
            </div>
            <div style="margin-bottom: 25px;">
                <label style="display:block; margin-bottom:8px; font-weight:700; color:#475569; font-size:0.8rem; text-transform:uppercase;">Ruta de Sistema</label>
                <input id="ir" style="width:100%; padding:14px; border:2px solid #e2e8f0; border-radius:14px; box-sizing:border-box;" placeholder="Ej: Men√∫ > Procesos">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:15px;">
                <button onclick="modal()" style="border:none; background:#f1f5f9; color:#64748b; padding:14px 30px; border-radius:14px; cursor:pointer; font-weight:700; transition:0.2s;">Cancelar</button>
                <button onclick="save()" style="border:none; background:var(--p); color:white; padding:14px 30px; border-radius:14px; cursor:pointer; font-weight:700; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); transition:0.2s;">Sincronizar</button>
            </div>
        </div>
    </div>

    <div id="toast">¬°Copiado con √©xito!</div>

    <script>
        const BID = '69680821ae596e708fdcc510';
        const KEY = '$2a$10$rbQNmKHZB95qMFO9kbzxwe3g8vO70vkKhSX7NrbuvZFYShj7duOOi';
        let db = [], ed = -1, fil = "TODOS";
        const pal = [{bg:'#e0e7ff',t:'#4338ca'},{bg:'#dcfce7',t:'#15803d'},{bg:'#ffedd5',t:'#c2410c'},{bg:'#fee2e2',t:'#b91c1c'},{bg:'#fae8ff',t:'#a21caf'},{bg:'#ccfbf1',t:'#0f766e'},{bg:'#fef9c3',t:'#a16207'},{bg:'#f3e8ff',t:'#7e22ce'},{bg:'#e0f2fe',t:'#0369a1'},{bg:'#ffe4e6',t:'#be123c'},{bg:'#f1f5f9',t:'#475569'}];

        async function init() {
            const timeout = setTimeout(() => { if(db.length===0) hideLoader("‚ö†Ô∏è Modo Local"); }, 4000);
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BID}/latest`, { headers: { 'X-Master-Key': KEY, 'X-Bin-Meta': false } });
                db = await res.json();
                clearTimeout(timeout);
                hideLoader("‚òÅÔ∏è Nube Activa", true);
            } catch {
                hideLoader("‚ö†Ô∏è Modo Local");
                db = JSON.parse(localStorage.getItem('ty_db')) || [];
            }
            render();
        }

        function hideLoader(txt, ok) {
            document.getElementById('loader').classList.add('hidden');
            const s = document.getElementById('status');
            s.innerText = txt;
            s.className = `status ${ok ? 'active' : 'local'}`;
        }

        async function sync() {
            localStorage.setItem('ty_db', JSON.stringify(db));
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${BID}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': KEY }, body: JSON.stringify(db) });
            } catch { console.log("Sync error"); }
        }

        function getColor(t){ if(!t)return pal[10]; let s=0; for(let i=0;i<t.length;i++)s+=t.charCodeAt(i); return pal[s%pal.length]; }

        function render() {
            const area = document.getElementById('chips'); area.innerHTML = "";
            const cats = ["TODOS", ...new Set(db.map(x=>x.clasificacion).filter(Boolean))].sort();
            cats.forEach(c => {
                const b = document.createElement('button'); b.className = `chip ${fil===c?'active':''}`;
                b.innerText = c; b.onclick = () => { fil = c; render(); };
                area.appendChild(b);
            });

            const res = document.getElementById('results'); res.innerHTML = "";
            const q = document.getElementById('q').value.toLowerCase();
            const filtered = db.map((x,i)=>({...x, idx:i})).filter(x => (x.titulo.toLowerCase().includes(q) || x.descripcion.toLowerCase().includes(q)) && (fil==="TODOS" || x.clasificacion===fil));
            
            if(filtered.length === 0) {
                res.innerHTML = '<div style="text-align:center;color:#94a3b8;margin-top:20px; animation: fadeIn 0.5s;">No se encontraron tipificaciones.</div>';
                return;
            }

            filtered.forEach((item, i) => {
                const c = getColor(item.clasificacion);
                const d = document.createElement('div'); 
                d.className = 'card'; 
                d.setAttribute('data-id', item.idx);
                d.style.animationDelay = `${i * 0.05}s`;
                d.innerHTML = `
                    <div class="card-bar" style="background:${c.t}"></div>
                    <div class="btns">
                        <button class="btn-a" onclick="modal(${item.idx})">‚úèÔ∏è</button>
                        <button class="btn-a del-btn" onclick="del(${item.idx})">üóëÔ∏è</button>
                    </div>
                    ${item.clasificacion ? `<span class="badge" style="background:${c.bg};color:${c.t}">${item.clasificacion}</span>` : ''}
                    <div class="titulo">${item.titulo}</div>
                    <div class="box" onclick="copy(${item.idx})">
                        <pre>${item.descripcion}</pre>
                    </div>
                    <div class="ruta">üìç ${item.ruta||'Sin ruta especificada'}</div>
                `;
                res.appendChild(d);
            });
        }

        function copy(i) { 
            navigator.clipboard.writeText(db[i].descripcion); 
            const t=document.getElementById('toast'); 
            t.classList.add('show'); 
            setTimeout(()=>t.classList.remove('show'),2500); 
        }

        function modal(i) { 
            ed=i; 
            document.getElementById('m').classList.toggle('active'); 
            if(i===-1){ 
                document.getElementById('mt').innerText="‚ú® Nueva Tipificaci√≥n"; 
                document.getElementById('ic').value=document.getElementById('it').value=document.getElementById('id').value=document.getElementById('ir').value=""; 
            } else if(i>=0){ 
                const x=db[i]; 
                document.getElementById('mt').innerText="‚úèÔ∏è Editar Registro"; 
                document.getElementById('ic').value=x.clasificacion||""; 
                document.getElementById('it').value=x.titulo; 
                document.getElementById('id').value=x.descripcion; 
                document.getElementById('ir').value=x.ruta||""; 
            } 
        }

        async function save() { 
            const o = { 
                clasificacion: document.getElementById('ic').value.trim().toUpperCase(), 
                titulo: document.getElementById('it').value.trim(), 
                descripcion: document.getElementById('id').value, 
                ruta: document.getElementById('ir').value.trim() 
            }; 
            if(!o.titulo) return; 
            if(ed===-1) db.unshift(o); else db[ed]=o; 
            await sync(); 
            modal(); 
            render(); 
        }

        async function del(i) { 
            if(confirm("¬øEliminar permanentemente de la nube?")){ 
                const card = document.querySelector(`.card[data-id="${i}"]`);
                if(card) card.classList.add('deleting');
                setTimeout(async () => {
                    db.splice(i,1); 
                    await sync(); 
                    render(); 
                }, 400);
            } 
        }

        document.getElementById('q').addEventListener('input', e => { 
            document.getElementById('bx').classList.toggle('show', e.target.value.length>0); 
            render(); 
        });

        document.getElementById('bx').onclick = () => { 
            document.getElementById('q').value=""; 
            document.getElementById('bx').classList.remove('show'); 
            render(); 
            document.getElementById('q').focus();
        };

        document.addEventListener('keydown', e => {
            if(e.key==='Escape') document.getElementById('bx').click();
            if((e.ctrlKey || e.metaKey) && e.key==='f') { e.preventDefault(); document.getElementById('q').focus(); }
        });

        window.onload = init;
    </script>
</body>
</html>
