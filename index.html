<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typify Pro (Enterprise Edition)</title>
    <style>
        /* =========================================
           ESTILOS ENTERPRISE (v39.0 - No Emojis)
           ========================================= */
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f8fafc;
            --text: #0f172a;
            --text-light: #64748b;
            --card-bg: #ffffff;
            --danger: #ef4444;
            --success: #10b981;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- ANIMACIONES --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes clickPulse { 0% { border-color: var(--primary); } 50% { border-color: var(--success); background: #f0fdf4; } 100% { border-color: #cbd5e1; background: #f1f5f9; } }

        /* --- HEADER --- */
        .header-final { width: 100%; max-width: 800px; text-align: center; margin-bottom: 40px; animation: fadeIn 0.6s ease; }
        
        h1 { 
            margin: 0 0 15px 0; 
            font-size: 2.2rem; font-weight: 800; letter-spacing: -0.02em;
            background: linear-gradient(135deg, #1e293b 0%, #4f46e5 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }

        /* --- STATUS INDICATOR (Punto de luz) --- */
        .status-pill {
            display: inline-flex; align-items: center; gap: 8px;
            font-size: 0.8rem; font-weight: 600; color: var(--text-light);
            background: white; padding: 6px 14px; border-radius: 50px;
            border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            margin-bottom: 30px; transition: all 0.3s ease;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; }
        .status-pill.active .status-dot { background: var(--success); animation: pulse 2s infinite; }
        .status-pill.error .status-dot { background: var(--danger); }
        .status-pill.error { color: var(--danger); border-color: #fecaca; background: #fef2f2; }

        /* --- BUSCADOR --- */
        .search-container { position: relative; width: 100%; max-width: 600px; margin: 0 auto; display: flex; align-items: center; }
        
        .search-icon { position: absolute; left: 16px; color: #94a3b8; width: 20px; height: 20px; pointer-events: none; transition: 0.3s; }
        
        .search-input {
            width: 100%; padding: 16px 45px 16px 48px; font-size: 1.1rem;
            border: 1px solid var(--border); border-radius: 16px;
            background: white; color: var(--text);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
            outline: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        .search-input:focus + .search-icon { color: var(--primary); }

        .btn-clear {
            position: absolute; right: 12px;
            background: none; border: none; cursor: pointer;
            color: #94a3b8; display: flex; align-items: center;
            padding: 4px; border-radius: 50%; transition: 0.2s;
            opacity: 0; visibility: hidden; transform: scale(0.8);
        }
        .btn-clear.visible { opacity: 1; visibility: visible; transform: scale(1); }
        .btn-clear:hover { background: #f1f5f9; color: var(--danger); }

        /* --- CHIPS --- */
        .chips-area { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-top: 25px; }
        .chip {
            background: white; border: 1px solid var(--border); color: var(--text-light);
            padding: 6px 16px; border-radius: 50px; cursor: pointer;
            font-size: 0.85rem; font-weight: 600; transition: all 0.2s;
        }
        .chip:hover { border-color: #cbd5e1; transform: translateY(-1px); }
        .chip.active { background: var(--text); color: white; border-color: var(--text); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }

        /* --- TARJETAS --- */
        #results { width: 100%; max-width: 800px; display: grid; gap: 16px; padding-bottom: 100px; }
        
        .card {
            background: white; padding: 24px; border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
            animation: fadeIn 0.4s ease forwards; opacity: 0;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 12px 24px -6px rgba(0,0,0,0.08); border-color: #cbd5e1; }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .card-meta { display: flex; flex-direction: column; gap: 4px; }
        .badge { 
            display: inline-flex; align-items: center; font-size: 0.7rem; font-weight: 700; 
            padding: 4px 10px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.05em;
        }
        .card-title { font-size: 1.15rem; font-weight: 700; color: #1e293b; line-height: 1.3; }

        .card-actions { display: flex; gap: 4px; opacity: 0; transform: translateX(10px); transition: 0.3s; }
        .card:hover .card-actions { opacity: 1; transform: translateX(0); }
        
        .icon-btn {
            background: transparent; border: none; padding: 8px; border-radius: 8px;
            color: #94a3b8; cursor: pointer; transition: 0.2s; display: flex;
        }
        .icon-btn:hover { background: #f1f5f9; color: var(--primary); }
        .icon-btn.delete:hover { color: var(--danger); background: #fef2f2; }

        /* --- DESCRIPCIÓN COPY --- */
        .desc-box {
            background: #f8fafc; border: 1px solid var(--border); border-radius: 12px;
            padding: 16px; margin-bottom: 12px; position: relative; cursor: pointer;
            transition: all 0.2s;
        }
        .desc-box:hover { border-color: var(--primary); background: #fff; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.05); }
        .desc-box.copied { animation: clickPulse 0.4s ease; }
        
        .desc-text { 
            font-family: 'Inter', sans-serif; font-size: 0.95rem; color: #334155; 
            line-height: 1.6; white-space: pre-wrap; margin: 0; pointer-events: none; 
        }
        
        /* Tooltip SVG */
        .copy-hint {
            position: absolute; top: 12px; right: 12px; 
            display: flex; align-items: center; gap: 4px;
            font-size: 0.75rem; font-weight: 600; color: var(--primary);
            opacity: 0; transform: translateY(5px); transition: 0.2s;
            background: white; padding: 4px 8px; border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05); border: 1px solid #e0e7ff;
        }
        .desc-box:hover .copy-hint { opacity: 1; transform: translateY(0); }

        .route-text { font-family: 'Courier New', monospace; font-size: 0.85rem; color: #94a3b8; display: flex; align-items: center; gap: 6px; }

        /* --- FAB & MODALS --- */
        .fab {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background: var(--text); color: white; border-radius: 50%;
            border: none; cursor: pointer; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 100;
        }
        .fab:hover { transform: scale(1.1); background: black; }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: 0.3s; z-index: 200;
        }
        .overlay.active { opacity: 1; visibility: visible; }
        
        .modal {
            background: white; width: 90%; max-width: 550px; padding: 32px;
            border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            transform: scale(0.95); transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .overlay.active .modal { transform: scale(1); }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #475569; }
        .form-input { 
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px;
            font-size: 1rem; background: #f8fafc; transition: 0.2s; box-sizing: border-box; font-family: inherit;
        }
        .form-input:focus { border-color: var(--primary); background: white; outline: none; }

        .btn-row { display: flex; justify-content: flex-end; gap: 12px; margin-top: 30px; }
        .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; border: none; font-size: 0.95rem; transition: 0.2s; }
        .btn-ghost { background: transparent; color: #64748b; }
        .btn-ghost:hover { background: #f1f5f9; color: var(--text); }
        .btn-primary { background: var(--text); color: white; }
        .btn-primary:hover { background: black; transform: translateY(-1px); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-danger:hover { background: #fecaca; }

        /* --- TOAST --- */
        #toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px;
            font-weight: 500; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); opacity: 0; visibility: hidden; transition: 0.3s; z-index: 1000;
        }
        #toast.visible { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }

        /* --- LOADER --- */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white;
            z-index: 2000; display: flex; align-items: center; justify-content: center;
            transition: opacity 0.4s;
        }
        .loader-overlay.hidden { opacity: 0; pointer-events: none; }
        .spinner-svg { width: 40px; height: 40px; animation: spin 0.8s linear infinite; color: var(--primary); }

    </style>
</head>
<body>

    <div id="loader" class="loader-overlay">
        <svg class="spinner-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
        </svg>
    </div>

    <div class="header-final">
        <h1>Typify Pro</h1>
        
        <div id="statusEl" class="status-pill">
            <div class="status-dot"></div>
            <span id="statusText">Conectando...</span>
        </div>

        <div class="search-container">
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" id="searchInput" class="search-input" placeholder="Buscar tipificación (Ctrl + F)" autocomplete="off">
            <button id="clearBtn" class="btn-clear">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>

        <div id="chipsArea" class="chips-area"></div>
    </div>

    <div id="results"></div>

    <div id="toast">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
        <span id="toastText">Copiado</span>
    </div>

    <button class="fab" onclick="openModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>

    <div class="overlay" id="mainModal">
        <div class="modal">
            <h2 id="modalTitle" style="margin:0 0 24px 0; color:#1e293b;">Nueva Tipificación</h2>
            <div style="display:flex; gap:16px;">
                <div class="form-group" style="flex:1">
                    <label class="form-label">Clasificación</label>
                    <input id="inClass" class="form-input" placeholder="Ej: PASOS">
                </div>
                <div class="form-group" style="flex:2">
                    <label class="form-label">Título</label>
                    <input id="inTitle" class="form-input" placeholder="Ej: Retiro de Ciclo">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Descripción (Script)</label>
                <textarea id="inDesc" class="form-input" rows="6" placeholder="Texto que se copiará..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Ruta / Sistema</label>
                <input id="inRoute" class="form-input" placeholder="Ej: CRM > Trámites">
            </div>
            <div class="btn-row">
                <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="btnSave" onclick="saveData()">Guardar</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="deleteModal">
        <div class="modal" style="max-width:400px; text-align:center;">
            <div style="width:60px; height:60px; background:#fee2e2; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px; color:#ef4444;">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
            </div>
            <h3 style="margin:0 0 8px 0;">¿Eliminar registro?</h3>
            <p style="color:#64748b; margin:0 0 24px 0;">Esta acción no se puede deshacer.</p>
            <div class="btn-row" style="justify-content:center;">
                <button class="btn btn-ghost" onclick="closeDelete()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Eliminar</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN (NO TOCAR) ---
        const BIN_ID = '6968712543b1c97be93195f1'; 
        const MASTER_KEY = '$2a$10$7PwFegDVLzoS8bJTQPdA7.27bk7D4odCTFnynWW1NkB5H6.PBt.nm';

        // --- ESTADO APP ---
        let db = [];
        let editIdx = -1;
        let filtro = "TODOS";
        let deleteIdx = null;

        // --- ELEMENTOS DOM ---
        const els = {
            loader: document.getElementById('loader'),
            status: document.getElementById('statusEl'),
            statusTxt: document.getElementById('statusText'),
            search: document.getElementById('searchInput'),
            clearBtn: document.getElementById('clearBtn'),
            chips: document.getElementById('chipsArea'),
            results: document.getElementById('results'),
            toast: document.getElementById('toast'),
            toastTxt: document.getElementById('toastText'),
            mainModal: document.getElementById('mainModal'),
            delModal: document.getElementById('deleteModal'),
            inputs: {
                class: document.getElementById('inClass'),
                title: document.getElementById('inTitle'),
                desc: document.getElementById('inDesc'),
                route: document.getElementById('inRoute')
            },
            modalTitle: document.getElementById('modalTitle'),
            btnSave: document.getElementById('btnSave')
        };

        // --- INICIO ---
        window.onload = () => { els.search.focus(); init(); };

        async function init() {
            // Failsafe local
            const t = setTimeout(() => { 
                if(db.length===0) { updateStatus(false, "Modo Local"); loadLocal(); hideLoader(); }
            }, 5000);

            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: {'X-Master-Key': MASTER_KEY} });
                if(!res.ok) throw new Error(res.status);
                const data = await res.json();
                
                db = Array.isArray(data.record) ? data.record : [];
                updateStatus(true, "En línea");
                clearTimeout(t);
            } catch (e) {
                console.warn(e);
                updateStatus(false, "Desconectado");
                loadLocal();
            }
            render();
            hideLoader();
        }

        // --- LÓGICA CORE ---
        function updateStatus(online, text) {
            els.status.className = `status-pill ${online ? 'active' : 'error'}`;
            els.statusTxt.innerText = text;
        }

        function loadLocal() { db = JSON.parse(localStorage.getItem('typify_db')) || []; }
        function hideLoader() { els.loader.classList.add('hidden'); }

        async function sync() {
            els.loader.classList.remove('hidden');
            localStorage.setItem('typify_db', JSON.stringify(db));
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY },
                    body: JSON.stringify(db)
                });
                if(!res.ok) throw new Error();
                updateStatus(true, "Guardado");
                showToast("Cambios guardados");
            } catch (e) {
                updateStatus(false, "Error al guardar");
                alert("No se pudo sincronizar con la nube. Se guardó localmente.");
            }
            hideLoader();
        }

        // --- RENDERIZADO ---
        const colors = [
            {bg:'#e0e7ff',t:'#4338ca'}, {bg:'#dcfce7',t:'#15803d'}, {bg:'#ffedd5',t:'#c2410c'},
            {bg:'#fee2e2',t:'#b91c1c'}, {bg:'#fae8ff',t:'#a21caf'}, {bg:'#ccfbf1',t:'#0f766e'},
            {bg:'#fef9c3',t:'#a16207'}, {bg:'#f3e8ff',t:'#7e22ce'}, {bg:'#e0f2fe',t:'#0369a1'}
        ];
        function getColor(str) { 
            if(!str) return colors[0];
            let hash = 0; for(let i=0; i<str.length; i++) hash += str.charCodeAt(i);
            return colors[hash % colors.length];
        }

        function render() {
            renderChips();
            renderResults(els.search.value);
        }

        function renderChips() {
            const cats = ["TODOS", ...new Set(db.map(x => x.clasificacion).filter(Boolean))].sort();
            els.chips.innerHTML = cats.map(c => `
                <button class="chip ${filtro===c ? 'active' : ''}" onclick="setFilter('${c}')">
                    ${c === "TODOS" ? "Todos" : c}
                </button>
            `).join('');
        }
        window.setFilter = (c) => { filtro = c; render(); };

        function renderResults(query = "") {
            const q = query.toLowerCase();
            const list = db.map((item, i) => ({...item, idx: i}))
                .filter(x => (filtro==="TODOS" || x.clasificacion===filtro) && 
                             (x.titulo.toLowerCase().includes(q) || x.descripcion.toLowerCase().includes(q)));

            if(list.length === 0) {
                els.results.innerHTML = `<div style="text-align:center; color:#94a3b8; padding:40px;">No se encontraron resultados</div>`;
                return;
            }

            els.results.innerHTML = list.map((item, i) => {
                const c = getColor(item.clasificacion);
                return `
                <div class="card" style="animation-delay:${i*0.05}s">
                    <div class="card-header">
                        <div class="card-meta">
                            ${item.clasificacion ? `<span class="badge" style="background:${c.bg}; color:${c.t}">${item.clasificacion}</span>` : ''}
                            <div class="card-title">${item.titulo}</div>
                        </div>
                        <div class="card-actions">
                            <button class="icon-btn" onclick="openModal(${item.idx})">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button class="icon-btn delete" onclick="askDelete(${item.idx})">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="desc-box" onclick="copyText(this, ${item.idx})">
                        <pre class="desc-text">${item.descripcion}</pre>
                        <div class="copy-hint">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            Copiar
                        </div>
                    </div>
                    <div class="route-text">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        ${item.ruta || 'General'}
                    </div>
                </div>`;
            }).join('');
        }

        // --- INTERACCIONES ---
        window.copyText = (el, idx) => {
            navigator.clipboard.writeText(db[idx].descripcion);
            el.classList.add('copied');
            setTimeout(() => el.classList.remove('copied'), 400);
            showToast("¡Copiado al portapapeles!");
        };

        function showToast(msg) {
            els.toastTxt.innerText = msg;
            els.toast.classList.add('visible');
            setTimeout(() => els.toast.classList.remove('visible'), 2000);
        }

        // --- MODALES ---
        window.openModal = (idx = -1) => {
            editIdx = idx;
            els.modalTitle.innerText = idx === -1 ? "Nueva Tipificación" : "Editar Registro";
            els.btnSave.innerText = idx === -1 ? "Crear" : "Guardar Cambios";
            
            const d = idx === -1 ? {} : db[idx];
            els.inputs.class.value = d.clasificacion || "";
            els.inputs.title.value = d.titulo || "";
            els.inputs.desc.value = d.descripcion || "";
            els.inputs.route.value = d.ruta || "";
            
            els.mainModal.classList.add('active');
            setTimeout(() => els.inputs.class.focus(), 100);
        };
        window.closeModal = () => els.mainModal.classList.remove('active');

        window.saveData = async () => {
            const item = {
                clasificacion: els.inputs.class.value.trim().toUpperCase(),
                titulo: els.inputs.title.value.trim(),
                descripcion: els.inputs.desc.value,
                ruta: els.inputs.route.value.trim()
            };
            if(!item.titulo) return alert("El título es obligatorio");

            if(editIdx === -1) db.unshift(item);
            else db[editIdx] = item;

            closeModal();
            render();
            await sync();
        };

        window.askDelete = (idx) => { deleteIdx = idx; els.delModal.classList.add('active'); };
        window.closeDelete = () => els.delModal.classList.remove('active');
        window.confirmDelete = async () => {
            if(deleteIdx !== null) {
                db.splice(deleteIdx, 1);
                closeDelete();
                render();
                await sync();
            }
        };

        // --- EVENTOS DE TECLADO & BUSQUEDA ---
        els.search.addEventListener('input', (e) => {
            const hasText = e.target.value.length > 0;
            els.clearBtn.classList.toggle('visible', hasText);
            renderResults(e.target.value);
        });

        els.clearBtn.addEventListener('click', () => {
            els.search.value = '';
            els.clearBtn.classList.remove('visible');
            els.search.focus();
            renderResults("");
        });

        document.addEventListener('keydown', (e) => {
            if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
                e.preventDefault();
                els.search.focus();
                els.search.select();
            }
            if(e.key === 'Escape') {
                if(els.mainModal.classList.contains('active')) closeModal();
                else if(els.delModal.classList.contains('active')) closeDelete();
                else if(document.activeElement === els.search || els.search.value.length > 0) {
                    els.search.value = '';
                    els.clearBtn.classList.remove('visible');
                    els.search.blur();
                    renderResults("");
                }
            }
        });
    </script>
</body>
</html>
